#!/usr/bin/env bash

# Initializes the composer.env file.

set -e

cd "$( dirname "${BASH_SOURCE:-$0}}" )"
cd ..

. ./bin/deps/utils.sh

########
# Step 1 - Create env/composer.env if it does not already exist
########

if [ ! -f "env/composer.env" ]; then
    if [ ! -f "env/composer.env.sample" ]; then
        echo "${RED}The file env/composer.env cannot be created because the template file env/composer.env.sample doesn't exist.${RESET}"
        exit 1
    fi

    cp "env/composer.env.sample" "env/composer.env"
    echo "${GREEN}✓ Created file env/composer.env.${RESET}"
else
    . ./env/composer.env
fi

########
# Step 2 - Fetch composer github token from host
########

if [ -z "$COMPOSER_GITHUB_TOKEN" ]; then
    COMPOSER_GITHUB_PATH="github-oauth.github.com"

    if command -v composer > /dev/null; then
        COMPOSER_GITHUB_TOKEN="$(composer config --global $COMPOSER_GITHUB_PATH 2>/dev/null)"

        if [ -n "$COMPOSER_GITHUB_TOKEN" ]; then
            sed -i "s/^COMPOSER_GITHUB_TOKEN=.*/COMPOSER_GITHUB_TOKEN=${COMPOSER_GITHUB_TOKEN}/g" env/composer.env
            echo "${GREEN}✓ The GitHub token \"$COMPOSER_GITHUB_TOKEN\" was saved saved in the env/composer.env file.${RESET}"
        else
            echo "No GitHub token found on the host."
        fi
    fi
fi

