#!/usr/bin/env bash

# Initializes the auth.json file.

set -e

cd "$( dirname "${BASH_SOURCE:-$0}}" )"
cd ../..

. ./docker/bin/deps/utils.sh
. ./.env # $PROJECT_NAME
. ./docker/env/magento.env # $SMILE_PACKAGIST

########
# Step 1 - Validate pre-requisites
########

if [ -z "$PROJECT_NAME" ]; then
    echo "${RED}Please set up the project before running this command.${RESET}"
    exit 1
fi

if [ -f "auth.json" ]; then
    echo "${GREEN}✓ The file auth.json already exists.${RESET}"
    exit
fi

########
# Step 2 - Read credentials from user input
########

echo "${YELLOW}No auth.json file at the project root, this setup will now ask for the missing composer credentials.${RESET}"

# Ask for github token only if it wasn't found on the host
if command -v composer > /dev/null; then
    # `|| true` avoids returning an error status, which would stop the script because of set -e
    COMPOSER_GITHUB_TOKEN="$(composer config --global github-oauth.github.com 2>/dev/null || true)"
fi

if [ -z "$COMPOSER_GITHUB_TOKEN" ]; then
    ask_input COMPOSER_GITHUB_TOKEN "Please specify a GitHub token.\nIf you don't already have one, you can create a new one from ${BLUE}https://github.com/settings/tokens${GREEN} and use it on any project that requires it."
fi

# Always ask for Magento credentials (they are specified to each project)
ask_input COMPOSER_MAGENTO_USERNAME "Please specify a Magento packagist ACL username (https://repo.magento.com)."
ask_input COMPOSER_MAGENTO_PASSWORD "Please specify a Magento packagist ACL password (https://repo.magento.com)."

# Ask for Smile credentials only when using the public packagist
if [ "$SMILE_PACKAGIST" = "public" ]; then
    ask_input COMPOSER_SMILE_USERNAME "Please specify a Smile packagist ACL username (https://packagist.smile.fr).\nIf you dont have one, you need to ask the technical direction (${BLUE}dirtech@smile.fr${GREEN}) to create an ACL for your project."
    ask_input COMPOSER_SMILE_PASSWORD "Please specify a Smile packagist ACL password (https://packagist.smile.fr)."
fi

########
# Step 3 - Write credentials to auth.json file
########

# Use --global if composer.json does not exist (otherwise composer config command would fail)
[ ! -f "composer.json" ] && CONFIG_OPT="--global"

COMMAND="composer config $CONFIG_OPT github-oauth.github.com \"$COMPOSER_GITHUB_TOKEN\" && \
    composer config $CONFIG_OPT http-basic.repo.magento.com \"$COMPOSER_MAGENTO_USERNAME\" \"$COMPOSER_MAGENTO_PASSWORD\""

[ "$SMILE_PACKAGIST" = "public" ] && \
    COMMAND="$COMMAND && composer config $CONFIG_OPT http-basic.\"packagist.smile.fr\" \"$COMPOSER_SMILE_USERNAME\" \"$COMPOSER_SMILE_PASSWORD\""

[ ! -f "composer.json" ] && \
    COMMAND="$COMMAND && mv \$COMPOSER_HOME/auth.json ."

if ! $DOCKER_COMMAND sh -c "$COMMAND"; then
    echo "${RED}Failed to initialize auth.json, aborting.${RESET}"
    exit 1
fi

echo "${GREEN}✓ The file auth.json was generated.${RESET}"
