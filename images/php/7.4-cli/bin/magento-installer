#!/bin/sh

set -e

RESET="$(tput sgr0)"
GREEN="$(tput setaf 2)"
BLUE="$(tput setaf 4)"

print_and_run () {
    echo "Running ${BLUE}$@${RESET}"
    eval "$@"
}

print_newline_and_run() {
    echo
    print_and_run "$@"
}

if [ ! -f "$MAGENTO_ROOT/composer.json" ]; then
    echo "Please setup the project before running this command."
    exit 1
fi

# Remove env.php and config.php files if it exists, otherwise the installation would fail
rm -f $MAGENTO_ROOT/app/etc/env.php $MAGENTO_ROOT/app/etc/config.php

MAGENTO_COMMAND="$MAGENTO_ROOT/bin/magento"

INSTALL_COMMAND="$MAGENTO_COMMAND setup:install \
    --db-host=$DB_HOST \
    --db-name=$DB_NAME \
    --db-user=$DB_USER \
    --db-password=$DB_PASSWORD \
    --elasticsearch-host=$ELASTICSEARCH_HOST \
    --base-url=$BASE_URL \
    --base-url-secure=$SECURE_BASE_URL \
    --use-secure=$USE_SECURE \
    --use-secure-admin=$USE_SECURE_ADMIN \
    --use-rewrites=$USE_REWRITES
    --backend-frontname=$BACKEND_FRONTNAME \
    --admin-firstname=$ADMIN_FIRSTNAME \
    --admin-lastname=$ADMIN_LASTNAME \
    --admin-email=$ADMIN_EMAIL \
    --admin-user=$ADMIN_USER \
    --admin-password=$ADMIN_PASSWORD \
    --language=$LANGUAGE \
    --currency=$CURRENCY \
    --magento-init-params=\"MAGE_MODE=$MAGENTO_RUN_MODE\""

if [ -n "$ENCRYPTION_KEY" ]; then
    INSTALL_COMMAND="$INSTALL_COMMAND \
        --key=$ENCRYPTION_KEY"
fi

if [ -n "$CACHE_PREFIX" ]; then
    INSTALL_COMMAND="$INSTALL_COMMAND \
        --cache-id-prefix=$CACHE_PREFIX \
        --page-cache-id-prefix=$CACHE_PREFIX"
fi

if [ "$USE_REDIS_CACHE" = "true" ]; then
    INSTALL_COMMAND="$INSTALL_COMMAND \
        --cache-backend=redis \
        --cache-backend-redis-server=$REDIS_CACHE_HOST \
        --cache-backend-redis-port=$REDIS_CACHE_PORT \
        --cache-backend-redis-db=$REDIS_CACHE_DB"
fi

if [ "$USE_REDIS_SESSIONS" = "true" ]; then
    INSTALL_COMMAND="$INSTALL_COMMAND \
        --session-save=redis \
        --session-save-redis-host=$REDIS_SESSIONS_HOST \
        --session-save-redis-port=$REDIS_SESSIONS_PORT \
        --session-save-redis-db=$REDIS_SESSIONS_DB \
        --session-save-redis-log-level=$REDIS_SESSIONS_LOG_LEVEL"
fi

if [ "$USE_VARNISH" = "true" ]; then
    INSTALL_COMMAND="$INSTALL_COMMAND \
        --http-cache-hosts=$HTTP_CACHE_HOSTS"
fi

print_and_run $INSTALL_COMMAND

# Set up Varnish
if [ "$USE_VARNISH" = "true" ]; then
    print_newline_and_run "$MAGENTO_COMMAND config:set --scope=default --scope-code=0 system/full_page_cache/caching_application 2"
    print_newline_and_run "$MAGENTO_COMMAND config:set --scope=default --scope-code=0 system/full_page_cache/varnish/access_list $VARNISH_ACCESS_LIST"
    print_newline_and_run "$MAGENTO_COMMAND config:set --scope=default --scope-code=0 system/full_page_cache/varnish/backend_host $VARNISH_BACKEND_HOST"
    print_newline_and_run "$MAGENTO_COMMAND config:set --scope=default --scope-code=0 system/full_page_cache/varnish/backend_port $VARNISH_BACKEND_PORT"
fi

# Disable two-factor authentication when developer mode is enabled
if [ "$MAGENTO_RUN_MODE" = "developer" ]; then
    print_newline_and_run "$MAGENTO_COMMAND module:disable Magento_TwoFactorAuth"
fi

if [ "$MAGENTO_RUN_MODE" = "production" ]; then
    print_newline_and_run "$MAGENTO_COMMAND setup:di:compile"
    print_newline_and_run "$MAGENTO_COMMAND cache:clean"
    print_newline_and_run "$MAGENTO_COMMAND setup:static-content:deploy -f en_US $LANGUAGE"
fi

print_newline_and_run "find $MAGENTO_ROOT/pub -type f -exec chmod 664 {} \;"
print_and_run "find $MAGENTO_ROOT/pub -type d -exec chmod 775 {} \;"
print_and_run "find $MAGENTO_ROOT/generated -type d -exec chmod g+s {} \;"
print_and_run "find $MAGENTO_ROOT/var/composer_home -type f -exec chmod 664 {} \;"

echo
echo "${GREEN}Installation complete.${RESET}"
